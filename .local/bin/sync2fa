#!/bin/bash
# Imports Aegis encrypted backup to KeePassXC

blue='\e[1;34m'
red='\e[1;31m'
white='\e[0;37m'
tmp_dir=$(mktemp -d -t aegis-XXXXXXXXXX)
dump_file=$tmp_dir/aegis.json
keepass_db=~/Dropbox/KeePass/2FA.kdbx
keepass_db_secret=$HOME/.ssh/s3cr3t.key
aegis_backup_file=~/aegis-backup.json
echo -e "${blue}Starting keepass-aegis sync${white}"

# Creating temp directory to store decrypted Aegis backup
aegis-decrypt --input $aegis_backup_file > $dump_file

# Exporting the dump to keepass, while making a backup of existing db
echo -e -n "\n\n${blue}KeePass Password: ${white}"; read -s password
if [[ -f "$keepass_db" ]]; then
    echo -e "\n\n${blue}Backing up existing db${white}\n\n"
    mv $keepass_db $keepass_db.bak
fi
printf '%s\n%s\n' "$password" "$password" | keepassxc-cli db-create -p -k $keepass_db_secret $keepass_db


echo -e "\n\n${blue}Importing aegis backup to newly created keepass db${white}\n\n"
pimport -af keepassxc aegis $dump_file --out $keepass_db -k $keepass_db_secret -vvv

echo -e "\n\n${blue}Removing temp files${white}"
# Securely delete the file once it is restored in keepass,
# https://www.howtogeek.com/425232/how-to-securely-delete-files-on-linux/
rm -rf $tmp_dir
