#!/bin/sh
# Script to enable, disable dark mode
# Changes background for following applications
# xresources, alacritty, tmux, vim, bat


help() {
    echo "Dark Mode"
    echo "   toggle:    toggle-dark"
    echo "   dark:      toggle-dark on"
    echo "   light:     toggle-dark off"
    exit
}

dark_mode_flag="/tmp/dark-mode.off"

change_xresources_theme() {
    echo -e "Requested xresource theme is: $1"
    theme=$1
    echo -e "Merging $HOME/.config/x11/${theme}.xres"
    xrdb $HOME/.config/x11/xresources
    xrdb -merge "$HOME/.config/x11/${theme}.xres"

    # TODO: Fix this, light-to-dark transition not working
    # Reloading all active instances of `st`
    # pidof st | xargs kill -SIGUSR1
}


change_alacritty_theme() {
    echo -e "Requested alacritty theme is: $1"
    alacritty_color_config="$HOME/.config/alacritty/color.yml"
    theme=$1
    if [[ ! -f $alacritty_color_config ]]; then
        echo -e "file ${alacritty_color_config} doesn't exist"
        return
    fi
    # sed doesn't like symlinks, get the absolute path
    config_path=$(readlink -f $alacritty_color_config)

    sed -i -e "s|^colors: \*.*|colors: *$theme|g" $config_path

    echo -e "switched to $theme."
}

change_tmux_theme() {
    echo -e "Requested tmux theme is: $1"
    theme=$1
    tmux source-file $HOME/.config/tmux/tmux.$theme.conf
}

change_vim_background() {
    echo -e "Requested vim background mode is: $1"
    # well, seems like there is no proper way to send a command to
    # Vim as a client. Luckily we're using tmux, which means we can
    # iterate over all vim pans and change the background ourself.

    for i in $(tmux list-panes -a -F '#{session_name}:#{window_index}.#{pane_index},#{pane_tty}') ; do
        # Above expression returns two values comma separated, Ex main:1.1,/dev/pts/3
        IFS=',' read pix tty_x <<< "${i}"
        processes=$(ps -o state= -o comm= -t ${tty_x})
        if [[ $(echo $processes  | grep -iE "^.* (nvim|gvim|vi|vim).*$") ]]; then
            tmux send-keys -t "$pix" escape ENTER
            tmux send-keys -t "$pix" ":call ToggleBackground(\"${1}\")" ENTER
        fi
    done
}

change_bat_theme() {
    echo -e "Requested bat theme is: $1"
    bat_config="$HOME/.config/bat/config"
    theme=$1
    if [[ ! -f $bat_config ]]; then
        echo -e "file ${bat_config} doesn't exist"
        return
    fi
    # sed doesn't like symlinks, get the absolute path
    config_path=$(readlink -f $bat_config)

    sed -i -e "s|^--theme=.*|--theme=\"$theme\"|g" $config_path

    echo -e "switched to $theme."
}

toggledark() {
    if [[ -f $dark_mode_flag ]]; then
        startdark
    else
        stopdark
    fi
}

# TODO: Change fzf theme
# TODO: Handle colorterm for light background
stopdark() {
    change_xresources_theme gruvbox-light
    change_alacritty_theme gruvbox_light
    change_vim_background light
    change_bat_theme gruvbox-light
    change_tmux_theme light
    touch $dark_mode_flag
}

startdark() {
    change_xresources_theme gruvbox-dark
    change_alacritty_theme gruvbox_dark
    change_vim_background dark
    change_bat_theme gruvbox-dark
    change_tmux_theme dark
    rm -f $dark_mode_flag
}

case "$1" in
    "")    toggledark; exit ;;
    "on")  startdark; exit ;;
    "off") stopdark; exit ;;
    *)     help ;;
esac
